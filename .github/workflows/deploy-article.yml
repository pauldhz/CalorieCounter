name: Deploy Article

on:
  push:
    branches:
      - develop
  schedule:
    - cron: '0 9 * * *'  # Tous les jours à 10h heure de Paris (9h UTC en hiver, 8h UTC en été)
  workflow_dispatch: # Permet de déclencher manuellement

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build blog
        run: yarn build:blog

      - name: Build for production
        run: yarn build --configuration=production

      - name: Checkout deployment repository
        uses: actions/checkout@v4
        with:
          repository: pauldhz/calorieCounterDeployment # Temp
          path: deployment
          token: ${{ secrets.DEPLOYMENT_TOKEN }}

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ vars.VPS_PORT }} ${{ vars.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Run deployment script
        working-directory: deployment/prod/deployment
        run: ./deployment.sh
        env:
            APP_NAME: ${{ vars.APP_NAME }}
            DOMAIN: ${{ vars.DOMAIN }}
            VPS_USER: ${{ vars.VPS_USER }}
            VPS_HOST: ${{ vars.VPS_HOST }}
            VPS_PORT: ${{ vars.VPS_PORT }}
            REMOTE_DIR: ${{ vars.REMOTE_DIR }}
            BUILD_PATH: ${{ github.workspace }}/dist
